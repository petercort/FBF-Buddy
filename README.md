<!--
  This README is autogenerated. Do not make modifications directly to this file.
  Changes should be made to the readme-template.yml file and the generate-readme.js script.
  -->

  # FBF Discord Buddy

  A discord app that helps with random tasks in the FBF discord!

  | Command | Inputs | Description | Example | Output |
| ------- | ------ | ----------- | ------- | ------ |
| /connect_strava | None | User authorizes access to the Strava app to collect information about your bikes. Permissions: scope=read, activity:read_all, profile:read_all | /connect_strava | A link to connect to Strava |
| /sync_bikes | None | Syncs bike data from Strava. | /sync_bikes | Returns bike data in the format Name (Brand, Model, Mileage) |
| /get_all_bikes | None | Gets all your bike data from Strava | /get_all_bikes | Returns bike data in the format Name (Brand, Model) | 
| /get_bike_by_name | name | Returns specific details about a bike | /get_bike_by_name name: Joe | Returns more bike data in the format name, brand, model, current mileage, and last waxed (date + mileage) | 
| /i_waxed_my_chain | bike_name (req) date (optional) mileage (optional) | Updated the last_waxed field on the app. With no optional params passed it will update to the current date and mileage. | /i_waxed_my_chain bike_name: Joe date: 12/24/2024 mileage: 355 | If successful, returns the date and mileage in the system for a last wax, otherwise returns an error. | 
| /get_last_ride | none | Returns the last ride you did according to Strava | /get_last_ride | Returns info on the last ride you did. |

  ## Known Issues
  - No known issues

  ## Local dev

  Clone the repository 
  `git clone ` 

  Install dependencies
  `cd fbf-buddy && npm install` 

  ## Setting up garbage
  We need to setup the following things: 
  Strava app 
  Postgres DB
  Azure KeyVault

  ### Strava App 
  
  Navigate to the secret [API application page](https://www.strava.com/settings/api)

  Fill out all the fields. For callback url with local dev, use your favorite webhook delivery tool like [ngrok](https://ngrok.com/)!
  *** Caveat! *** Strava's API sucks and you can't use paths in your webhook callback url, so something like smee.io won't work because it appends the UID as a path (ie smee.io/324lkjdfs), and that breaks Strava. Ngrok prepends as a subdomain (ie 324lkjdfs.ngrok-app.free) wwhich is ok (???). 

  Save the Client ID, Client Secret, and your webhook delivery url, as we need to dump those in our Azure Key Vault later!

  Lots of things rely on azure to make dev and production easier! 

  Database: create a postgres db, I used cosmos DB but I suppose you could use a local postgres db for this. 

  Secrets are stored in an azure keyvault and are required! Create an azure keyvault and add the following secrets
  | secret name | description and where to get it | 
  | ----------- | ------------------------------- | 
  | appid | Discord app ID | 
  | discordtoken | Token for your discord app | 
  | guildid | Guild ID from discord | 
  | publickey | Discord public key | 
  | databaseUrl | Postgres connection string created earlier | 
  | stravaClientId | Client ID from Strava integration | 
  | stravaclientsecret | Secret from Strava integration | 
  | stravaredirecturi | Redirect URI from Strava integration (used for auth callback and subscription setup) | 
  | stravaVerifyToken | Strava webhook verification token (you generate this!) | 


  Once everything is setup, we need to add a Strava webhook subscription. Run the following command, replacing the clientID, clientSecret, and webhook delivery callbackUrl with the values from earlier: 
  ```
  curl -X POST \
  https://www.strava.com/api/v3/push_subscriptions \
  -F client_id=$clientID \
  -F client_secret=$clientSecret \
  -F callback_url=$callbackUrl \
  -F verify_token=$stravaVerifyToken
  ```

  

  ## Owner Maintainers
  - @petercort


  